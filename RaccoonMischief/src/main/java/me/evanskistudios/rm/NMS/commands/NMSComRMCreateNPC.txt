package me.evanskistudios.rm.NMS.commands;

import com.mojang.authlib.GameProfile;
import com.mojang.authlib.properties.Property;
import net.minecraft.network.protocol.game.ClientboundAddPlayerPacket;
import net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket;
import net.minecraft.server.MinecraftServer;
import net.minecraft.server.level.ServerLevel;
import net.minecraft.server.level.ServerPlayer;
import net.minecraft.server.network.ServerGamePacketListenerImpl;
import org.bukkit.ChatColor;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.craftbukkit.v1_20_R1.entity.CraftPlayer;
import org.bukkit.entity.Player;

import java.util.UUID;

public class NMSComRMCreateNPC implements CommandExecutor{


    @Override
    public boolean onCommand(CommandSender sender, Command command, String label, String[] args) {

        String no_permission = (ChatColor.RED + "You lack sufficient permission to execute this command");
        if (!sender.hasPermission("RaccoonMischief.RMCreateNPC")) {
            sender.sendMessage(no_permission);
            return true;
        }

        if (sender instanceof Player player){
            CraftPlayer craftPlayer = (CraftPlayer) player;
            ServerPlayer sp = craftPlayer.getHandle();

            MinecraftServer server = sp.getServer();
            ServerLevel level = sp.serverLevel();

            String npc_name = "Not-ch";

            GameProfile gameProfile = new GameProfile(UUID.randomUUID(), npc_name);

            String signature = "DGgLCpIZX3LVd9JuOxhkFe2nADE5CLdMvJN3EdRsIma62WG/yVpX74uVK6c9+Cz24h8z4HSTzg5k0HPYe6xDvZeMlCYdw6JkIx0Aw2I7yoWuKP18GSRFHSkkKDC41iRoF1RirH8zIBLjvkGgBdM/wY9CfYe6/+1Ich0dFAecYsvxp1rgRqImCIj+LZsuKGTfzJjCzXZhxh/cqr66VrmrICRXznB7C6nDKi8zy1Dc1LW6kYbrobmKHcu7kTC6o4Pk2TQK4B4Aw37BGY3KG0X0sdipqLJiOHgN3oSkJEvSRpVknhZKcMIQytM2S7IUfKbOnQAlQWZ4vG7AVw0eRTrv47HyLO+gcMFQpLt0NJD6L+7i8djX9LaZyBIWWUsjroh+h5IwiMrorh54Agn92YAXw+6HzuH31P8Lf0F58aN+E2/TDMF9VOc5hFyZRkX7094IClGUlDwmbqmJbKi0yvFvWELQGeMvuh/tGREqbOQxnV6CM2nBWwYKC/r92OFEmlDvxEKsiWOEZ5fCKJ50f9SiZPP0C70AIhFG0U4SYOVE6W3kaPakYRULrm4PEZcd5lnz1pb0RLSzKKhTNDx5soPddKNXo2myLyiuNLwoqXPj0qtGDPyI5tsOqmt6PapjiN+vevmLiRTBldKVnGVa4b/tGa18wt9/Jg4vuCKFmvPR3Pw=";
            String texture = "ewogICJ0aW1lc3RhbXAiIDogMTY4OTU2MzgzMDU5OCwKICAicHJvZmlsZUlkIiA6ICIwNjlhNzlmNDQ0ZTk0NzI2YTViZWZjYTkwZTM4YWFmNSIsCiAgInByb2ZpbGVOYW1lIiA6ICJOb3RjaCIsCiAgInNpZ25hdHVyZVJlcXVpcmVkIiA6IHRydWUsCiAgInRleHR1cmVzIiA6IHsKICAgICJTS0lOIiA6IHsKICAgICAgInVybCIgOiAiaHR0cDovL3RleHR1cmVzLm1pbmVjcmFmdC5uZXQvdGV4dHVyZS8yOTIwMDlhNDkyNWI1OGYwMmM3N2RhZGMzZWNlZjA3ZWE0Yzc0NzJmNjRlMGZkYzMyY2U1NTIyNDg5MzYyNjgwIgogICAgfQogIH0KfQ==";

            gameProfile.getProperties().put("textures", new Property("textures", texture, signature));

            ServerPlayer npc = new ServerPlayer(server, level, gameProfile);
            npc.setPos(player.getLocation().getX(), player.getLocation().getY(), player.getLocation().getZ());

            ServerGamePacketListenerImpl ps = sp.connection;

            //PlayerInfoPacket
            ps.send(new ClientboundPlayerInfoUpdatePacket(ClientboundPlayerInfoUpdatePacket.Action.ADD_PLAYER, npc));

            //Spawn Packet
            ps.send(new ClientboundAddPlayerPacket(npc));

            sender.sendMessage(ChatColor.YELLOW+"Welcome to HELL, "+npc_name+"!");
        }

        return true;
    }
}
